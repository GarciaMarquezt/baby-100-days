<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>å®å®æˆé•¿ç›¸å†Œ - ä¸¥å±¹ç›</title>
    <link rel="stylesheet" href="style.css">
    <!-- å¼•å…¥ Fancybox -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fancyapps/ui@5.0/dist/fancybox/fancybox.css"/>
    
    <style>
        body { background-color: #fff5f5; min-height: 100vh; padding: 0; }
        .gallery-container { padding: 20px; max-width: 800px; margin: 0 auto; }
        .back-btn { display: inline-block; margin-bottom: 20px; padding: 8px 15px; background: #fff; border-radius: 20px; text-decoration: none; color: #d32f2f; font-size: 0.9rem; box-shadow: 0 2px 5px rgba(0,0,0,0.1); }
        .section-title { color: #d32f2f; margin: 20px 0 10px; border-left: 4px solid #d32f2f; padding-left: 10px; font-size: 1.2rem; }
        
        .gallery-grid { display: grid; grid-template-columns: repeat(2, 1fr); gap: 15px; }
        
        /* æ–°ç‰ˆå¡ç‰‡æ ·å¼ */
        .media-card { background: #fff; border-radius: 8px; overflow: hidden; box-shadow: 0 2px 8px rgba(0,0,0,0.1); position: relative; }
        .media-thumb { width: 100%; aspect-ratio: 1/1; object-fit: cover; display: block; }
        .pinned-badge { position: absolute; top: 5px; left: 5px; background: #ffd700; color: #d32f2f; padding: 2px 6px; border-radius: 4px; font-size: 0.7rem; font-weight: bold; z-index: 2; box-shadow: 0 2px 4px rgba(0,0,0,0.2); }
        
        /* äº¤äº’æ  */
        .card-actions { display: flex; justify-content: space-between; padding: 8px 10px; border-top: 1px solid #eee; align-items: center; }
        .action-btn { border: none; background: none; cursor: pointer; font-size: 0.9rem; color: #666; display: flex; align-items: center; gap: 4px; }
        .action-btn.liked { color: #d32f2f; }
        
        /* è¯„è®ºåŒºé¢„è§ˆ */
        .comment-preview { padding: 0 10px 10px; font-size: 0.8rem; color: #888; }
        .comment-item { margin-top: 4px; background: #f9f9f9; padding: 4px; border-radius: 4px; }

        /* ç®¡ç†å‘˜ç½®é¡¶æŒ‰é’® (å¹³æ—¶éšè—) */
        .admin-pin-btn { position: absolute; top: 5px; right: 5px; background: rgba(0,0,0,0.5); color: #fff; border: none; width: 24px; height: 24px; border-radius: 50%; font-size: 0.8rem; cursor: pointer; display: none; z-index: 3; }
        .admin-mode .admin-pin-btn { display: block; }

        .video-wrapper video { width: 100%; display: block; border-radius: 8px; }
        
        .end-text { text-align: center; color: #999; margin: 40px 0; font-size: 0.8rem; cursor: pointer; user-select: none; }
    </style>
</head>
<body>

    <div class="gallery-container">
        <a href="index.html" class="back-btn">â¬… è¿”å›é‚€è¯·å‡½</a>
        <h1 id="secretTitle" style="text-align: center; color: #d32f2f; margin-bottom: 30px; cursor: pointer;">ğŸ‘¶ å±¹ç›æˆé•¿è®°å½•</h1>

        <!-- è§†é¢‘åŒºåŸŸ (éšæœºå±•ç¤º) -->
        <div class="section-title">ğŸ¥ ç²¾å½©è§†é¢‘ (éšæœºæ’­æ”¾)</div>
        <div class="gallery-grid" id="videoContainer">
            <!-- JS åŠ¨æ€æ’å…¥ -->
        </div>

        <!-- ç…§ç‰‡åŒºåŸŸ -->
        <div class="section-title">ğŸ“¸ ç²¾å½©ç¬é—´</div>
        <div class="gallery-grid" id="imageContainer">
            <!-- JS åŠ¨æ€æ’å…¥ -->
        </div>

        <div class="end-text" id="secretFooter">- æŒç»­æ›´æ–°ä¸­ -</div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/@fancyapps/ui@5.0/dist/fancybox/fancybox.umd.js"></script>
    <script>
        Fancybox.bind("[data-fancybox]", {});

        // --- é…ç½® ---
        // è®°å¾—æŠŠ upload.php é‡å‘½åä¸º api.php
        const API_URL = "https://upload.1101020.xyz/api.php"; 
        
        let isAdmin = false; // æ˜¯å¦å¼€å¯ç®¡ç†å‘˜æ¨¡å¼

        // --- åˆå§‹åŒ–åŠ è½½ ---
        function loadData() {
            fetch(API_URL + "?action=list")
            .then(res => res.json())
            .then(data => {
                if (data.success) {
                    renderGrid('videoContainer', data.videos);
                    renderGrid('imageContainer', data.images);
                }
            });
        }

        // --- æ¸²æŸ“å‡½æ•° ---
        function renderGrid(containerId, items) {
            const container = document.getElementById(containerId);
            container.innerHTML = '';
            
            items.forEach(item => {
                const isVideo = item.type === 'video';
                const div = document.createElement('div');
                div.className = 'media-card';
                
                // æ˜¯å¦ç½®é¡¶çš„è§’æ ‡
                const pinBadge = item.is_pinned == 1 ? '<div class="pinned-badge">â˜… ç½®é¡¶</div>' : '';
                
                // åª’ä½“å†…å®¹
                let mediaHtml = '';
                if (isVideo) {
                    mediaHtml = `
                        <a href="${item.url}" data-fancybox="gallery">
                            <img class="media-thumb" src="${item.url}#t=0.1" onerror="this.src='babyimage/video_cover.jpg'"> <!-- è§†é¢‘æˆªå›¾ -->
                            <span class="video-icon" style="position:absolute;top:50%;left:50%;transform:translate(-50%,-50%);color:#fff;font-size:2rem;pointer-events:none;">â–¶</span>
                        </a>`;
                } else {
                    mediaHtml = `
                        <a href="${item.url}" data-fancybox="gallery">
                            <img class="media-thumb" src="${item.url}" loading="lazy">
                        </a>`;
                }

                // è¯„è®ºé¢„è§ˆ (åªæ˜¾ç¤ºæœ€æ–°ä¸€æ¡)
                let commentsHtml = '';
                if (item.comments && item.comments.length > 0) {
                    commentsHtml = `<div class="comment-preview"><div class="comment-item">ğŸ’¬ ${item.comments[0].content}</div></div>`;
                }

                div.innerHTML = `
                    ${pinBadge}
                    <button class="admin-pin-btn" onclick="togglePin(${item.id})">ğŸ“Œ</button>
                    ${mediaHtml}
                    <div class="card-actions">
                        <button class="action-btn" onclick="likeItem(${item.id}, this)">
                            <span class="heart-icon">${item.likes > 0 ? 'â¤ï¸' : 'ğŸ¤'}</span> 
                            <span class="count">${item.likes || 'èµ'}</span>
                        </button>
                        <button class="action-btn" onclick="commentItem(${item.id})">
                            ğŸ’¬ è¯„è®º
                        </button>
                    </div>
                    ${commentsHtml}
                `;
                container.appendChild(div);
            });
        }

        // --- äº¤äº’åŠŸèƒ½ ---

        // ç‚¹èµ
        window.likeItem = function(id, btn) {
            // ç®€å•çš„é˜²åˆ·ï¼šæ£€æŸ¥ localStorage
            if (localStorage.getItem('liked_' + id)) {
                alert('æ‚¨å·²ç»ç‚¹è¿‡èµå•¦ï¼');
                return;
            }

            fetch(API_URL + "?action=like", {
                method: 'POST',
                body: JSON.stringify({ id: id })
            })
            .then(res => res.json())
            .then(data => {
                if (data.success) {
                    localStorage.setItem('liked_' + id, '1');
                    const icon = btn.querySelector('.heart-icon');
                    const count = btn.querySelector('.count');
                    icon.innerText = 'â¤ï¸';
                    // ç®€å•çš„æ•°å­—+1åŠ¨ç”»æ•ˆæœ
                    let num = parseInt(count.innerText) || 0;
                    count.innerText = num + 1;
                    btn.classList.add('liked');
                }
            });
        };

        // è¯„è®º
        window.commentItem = function(id) {
            const content = prompt("è¯·è¾“å…¥æ‚¨çš„ç¥ç¦æˆ–è¯„è®ºï¼š");
            if (!content) return;

            fetch(API_URL + "?action=comment", {
                method: 'POST',
                body: JSON.stringify({ id: id, content: content })
            })
            .then(res => res.json())
            .then(data => {
                if (data.success) {
                    alert('è¯„è®ºæˆåŠŸï¼');
                    loadData(); // åˆ·æ–°åˆ—è¡¨
                }
            });
        };

        // ç½®é¡¶ (ç®¡ç†å‘˜åŠŸèƒ½)
        window.togglePin = function(id) {
            const password = prompt("è¯·è¾“å…¥ç®¡ç†å‘˜å¯†ç ä»¥ç¡®è®¤æ“ä½œï¼š"); // è¿™é‡Œç®€å•ç‚¹ï¼Œæ¯æ¬¡éƒ½éªŒè¯ï¼Œæˆ–è€…ä½ å¯ä»¥å­˜å…¨å±€å˜é‡
            if (!password) return;

            fetch(API_URL + "?action=pin", {
                method: 'POST',
                body: JSON.stringify({ id: id, password: password })
            })
            .then(res => res.json())
            .then(data => {
                if (data.success) {
                    alert('ç½®é¡¶çŠ¶æ€å·²æ›´æ–°');
                    loadData();
                } else {
                    alert(data.message);
                }
            });
        };

        // --- éšè—å½©è›‹ & ç®¡ç†å‘˜æ¨¡å¼ ---
        let clickCount = 0;
        let clickTimer = null;
        
        // ä¸Šä¼ åŠŸèƒ½ç›¸å…³
        const fileInput = document.createElement('input');
        fileInput.type = 'file';
        fileInput.accept = 'image/*,video/*';
        fileInput.style.display = 'none';
        document.body.appendChild(fileInput);
        
        fileInput.onchange = function(e) {
            const file = e.target.files[0];
            if (!file) return;
            const formData = new FormData();
            formData.append('file', file);
            
            document.getElementById('secretTitle').innerText = "â³ ä¸Šä¼ ä¸­...";
            fetch(API_URL + "?action=upload", { method: 'POST', body: formData })
            .then(res => res.json())
            .then(data => {
                if(data.success) { alert('ä¸Šä¼ æˆåŠŸï¼'); loadData(); }
                else { alert('å¤±è´¥'); }
            })
            .finally(() => document.getElementById('secretTitle').innerText = "ğŸ‘¶ å±¹ç›æˆé•¿è®°å½•");
        };

        function checkSecretTrigger() {
            clickCount++;
            if (clickTimer) clearTimeout(clickTimer);
            clickTimer = setTimeout(() => { clickCount = 0; }, 1000);

            if (clickCount >= 5) {
                const action = prompt("ğŸ‰ å½©è›‹è§¦å‘ï¼\n\n1. ä¸Šä¼ ç…§ç‰‡/è§†é¢‘\n2. å¼€å¯ç®¡ç†å‘˜æ¨¡å¼(ç½®é¡¶åŠŸèƒ½)\nè¯·è¾“å…¥æ•°å­—ï¼š");
                if (action == '1') {
                    fileInput.click();
                } else if (action == '2') {
                    const pwd = prompt("è¯·è¾“å…¥ç®¡ç†å‘˜å¯†ç ï¼š");
                    // è¿™é‡Œåªæ˜¯å‰ç«¯ç®€å•çš„æ˜¾ç¤ºéšè—UIï¼ŒçœŸæ­£çš„æƒé™åœ¨åç«¯éªŒè¯
                    // ä¸ºäº†æ¼”ç¤ºæ–¹ä¾¿ï¼Œå‡è®¾å¯†ç æ˜¯ 123 (è™½ç„¶è¿™ä¸å®‰å…¨ï¼ŒçœŸæ­£æ ¡éªŒåœ¨åç«¯æ¥å£)
                    if (pwd === '123') { 
                        document.body.classList.add('admin-mode');
                        alert("ç®¡ç†å‘˜æ¨¡å¼å·²å¼€å¯ï¼ç°åœ¨ç‚¹å‡»å›¾ç‰‡å³ä¸Šè§’çš„ğŸ“Œå¯ä»¥ç½®é¡¶ã€‚");
                    }
                }
                clickCount = 0;
            }
        }

        document.getElementById('secretTitle').addEventListener('click', checkSecretTrigger);
        document.getElementById('secretFooter').addEventListener('click', checkSecretTrigger);

        // å¯åŠ¨
        loadData();

    </script>
</body>
</html>